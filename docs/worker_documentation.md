# Workers - Оптимизированный API для обработки данных

## Обзор

API для управления задачами обработки данных с пагинацией. Оптимизирован для минимального количества эндпоинтов и максимальной функциональности.

## Эндпоинты

### 1. Основной API для управления задачами
**URL:** `GET/POST /api/v1/workers/`

#### GET - Получить список задач
- **Описание:** Получить список задач обработки данных с пагинацией
- **Параметры запроса:**
  - `status` (опционально) - фильтр по статусу: `pending`, `processing`, `completed`, `failed`, `cancelled`
  - `task_type` (опционально) - фильтр по типу задачи
  - `page` (опционально) - номер страницы
  - `page_size` (опционально) - размер страницы (максимум 100)

#### POST - Создать новую задачу
- **Описание:** Создать новую задачу обработки данных
- **Тело запроса:**
```json
{
  "task_type": "bookings_export",
  "batch_size": 100,
  "filters": {},
  "date_from": "2024-01-01T00:00:00Z",
  "date_to": "2024-12-31T23:59:59Z"
}
```

### 2. Детали и управление задачей
**URL:** `GET/DELETE /api/v1/workers/{task_id}/`

#### GET - Получить детали задачи
- **Описание:** Получить детальную информацию о задаче

#### DELETE - Отменить задачу
- **Описание:** Отменить выполнение задачи (только для задач в статусе `pending` или `processing`)

### 3. Статус задачи
**URL:** `GET /api/v1/workers/{task_id}/status/`

#### GET - Получить статус задачи
- **Описание:** Получить текущий статус и прогресс выполнения задачи

## Типы задач

- `bookings_export` - Экспорт бронирований
- `payments_export` - Экспорт платежей
- `users_export` - Экспорт пользователей
- `services_export` - Экспорт услуг
- `data_cleanup` - Очистка данных
- `data_analysis` - Анализ данных
- `report_generation` - Генерация отчетов

## Статусы задач

- `pending` - Ожидает
- `processing` - Обрабатывается
- `completed` - Завершено
- `failed` - Ошибка
- `cancelled` - Отменено

## Примеры использования

### Создание задачи экспорта бронирований
```bash
curl -X POST "http://localhost:8000/api/v1/workers/" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "task_type": "bookings_export",
    "batch_size": 100,
    "filters": {"status": "confirmed"},
    "date_from": "2024-01-01T00:00:00Z",
    "date_to": "2024-12-31T23:59:59Z"
  }'
```

### Получение списка задач
```bash
curl -X GET "http://localhost:8000/api/v1/workers/?status=processing&page=1&page_size=20" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### Проверка статуса задачи
```bash
curl -X GET "http://localhost:8000/api/v1/workers/1/status/" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### Отмена задачи
```bash
curl -X DELETE "http://localhost:8000/api/v1/workers/1/" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## Особенности

1. **Автоматическая обработка:** Задачи запускаются автоматически в отдельном потоке
2. **Пагинация:** Все списки поддерживают пагинацию
3. **Фильтрация:** Поддержка фильтров по статусу и типу задачи
4. **Безопасность:** Проверка прав доступа (пользователи видят только свои задачи)
5. **Транзакции:** Все операции записи обернуты в транзакции
6. **Обработка ошибок:** Централизованная обработка ошибок с кодами

## Оптимизации

- Убраны избыточные эндпоинты
- Объединены связанные операции в один раздел
- Упрощена структура данных
- Удалена модель ProcessingBatch для упрощения
- Оставлены только необходимые поля в сериализаторах 